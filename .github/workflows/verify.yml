name: verify

on:
  workflow_dispatch:
    inputs:
      displayed_apy_percent:
        description: "APY shown on Arcadia website (percent, e.g. 293814.8)."
        required: false
        default: ""
      principal_usdc:
        description: "Principal in USDC for realized-return calc (e.g. 1000)"
        required: false
        default: ""
      profit_usdc:
        description: "Realized profit in USDC over the window (e.g. 2.84)"
        required: false
        default: ""
      duration_hours:
        description: "Time window in hours (e.g. 18)"
        required: false
        default: ""

permissions:
  contents: write

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build receipt from latest_strategy_405.json (+ realized return if provided)
        shell: bash
        env:
          DISPLAYED_APY_PERCENT: ${{ github.event.inputs.displayed_apy_percent }}
          PRINCIPAL_USDC: ${{ github.event.inputs.principal_usdc }}
          PROFIT_USDC: ${{ github.event.inputs.profit_usdc }}
          DURATION_HOURS: ${{ github.event.inputs.duration_hours }}
        run: |
          set -euo pipefail

          IN_FILE="data/latest_strategy_405.json"
          OUT_DIR="artifacts"
          TS="$(date -u +'%Y%m%dT%H%M%SZ')"
          OUT_FILE="${OUT_DIR}/receipt.json"
          SNAP_FILE="${OUT_DIR}/receipt_${TS}.json"

          if [ ! -f "${IN_FILE}" ]; then
            echo "ERROR: ${IN_FILE} not found. Run fetch_arcadia first."
            exit 1
          fi

          mkdir -p "${OUT_DIR}"

          python - << 'PY'
          import json, hashlib, time, os, math

          from pathlib import Path

          def sha256_hex(b: bytes) -> str:
              return hashlib.sha256(b).hexdigest()

          def canonical_json_bytes(obj) -> bytes:
              return json.dumps(obj, sort_keys=True, separators=(",", ":"), ensure_ascii=False).encode("utf-8")

          # Read env inputs
          displayed_str = (os.environ.get("DISPLAYED_APY_PERCENT") or "").strip()
          principal_str = (os.environ.get("PRINCIPAL_USDC") or "").strip()
          profit_str = (os.environ.get("PROFIT_USDC") or "").strip()
          hours_str = (os.environ.get("DURATION_HOURS") or "").strip()

          # Load latest strategy
          raw = json.loads(Path("data/latest_strategy_405.json").read_text(encoding="utf-8"))

          required_keys = ["strategy_id", "strategy_name", "strategy_apy"]
          missing = [k for k in required_keys if k not in raw]

          strategy_id = raw.get("strategy_id")
          strategy_name = raw.get("strategy_name")
          strategy_apy_raw = raw.get("strategy_apy")

          underlyings = raw.get("underlyings", [])
          details = raw.get("details", {})
          tvl = details.get("total_value_locked") if isinstance(details, dict) else None

          # --- Arcadia unit: confirmed fraction ---
          apy_fraction = None
          apy_percent_from_api = None
          unit_ok = False
          try:
              apy_fraction = float(strategy_apy_raw)
              apy_percent_from_api = apy_fraction * 100.0
              unit_ok = True
              unit_detail = "confirmed: api_fraction * 100 = displayed_percent"
          except Exception:
              unit_detail = "strategy_apy not numeric"

          # --- Compare with displayed APY% if provided ---
          displayed_apy_percent = None
          deviation_abs_percent = None
          deviation_rel = None
          deviation_check_pass = None
          deviation_detail = "not_provided"

          if displayed_str:
              try:
                  displayed_apy_percent = float(displayed_str)
                  if apy_percent_from_api is not None:
                      deviation_abs_percent = apy_percent_from_api - displayed_apy_percent
                      deviation_rel = deviation_abs_percent / displayed_apy_percent if displayed_apy_percent != 0 else None
                      tol = 0.005  # 0.5% relative tolerance
                      deviation_check_pass = (deviation_rel is not None and abs(deviation_rel) <= tol)
                      deviation_detail = f"rel_tol={tol}"
                  else:
                      deviation_check_pass = False
                      deviation_detail = "api_percent_unavailable"
              except Exception:
                  deviation_check_pass = False
                  deviation_detail = "invalid_displayed_input"

          # --- Realized return calculation (optional) ---
          realized = {
              "provided": False,
              "principal_usdc": None,
              "profit_usdc": None,
              "duration_hours": None,
              "roi": None,
              "apr_simple": None,
              "apy_compound_daily": None,
              "apy_compound_continuous": None,
              "notes": []
          }

          realized_ok = True
          if principal_str or profit_str or hours_str:
              # If any is provided, require all three
              if not (principal_str and profit_str and hours_str):
                  realized_ok = False
                  realized["notes"].append("If providing realized return, principal_usdc, profit_usdc, and duration_hours must all be set.")
              else:
                  try:
                      principal = float(principal_str)
                      profit = float(profit_str)
                      hours = float(hours_str)
                      if principal <= 0 or hours <= 0:
                          raise ValueError("principal and duration must be > 0")

                      roi = profit / principal  # over the window
                      periods_per_year = (365.0 * 24.0) / hours

                      apr_simple = roi * periods_per_year  # linear annualization
                      apy_daily = (1.0 + roi) ** periods_per_year - 1.0
                      apy_cont = math.exp(roi * periods_per_year) - 1.0  # rough continuous-comp approx

                      realized.update({
                          "provided": True,
                          "principal_usdc": principal,
                          "profit_usdc": profit,
                          "duration_hours": hours,
                          "roi": roi,
                          "apr_simple": apr_simple,
                          "apy_compound_daily": apy_daily,
                          "apy_compound_continuous": apy_cont
                      })
                  except Exception as e:
                      realized_ok = False
                      realized["notes"].append(f"Invalid realized inputs: {e}")

          # --- Checks ---
          checks = []
          checks.append({"name": "input_present", "pass": len(missing) == 0, "detail": ("missing: " + ", ".join(missing)) if missing else "ok"})
          checks.append({"name": "unit_confirmed", "pass": unit_ok, "detail": unit_detail})
          checks.append({"name": "displayed_match_within_tolerance", "pass": (deviation_check_pass if deviation_check_pass is not None else True), "detail": deviation_detail})
          checks.append({"name": "realized_inputs_valid", "pass": realized_ok, "detail": "ok" if realized_ok else "invalid_or_incomplete"})

          # --- Digests ---
          inputs_for_digest = {
              "target": {"chain_id": 8453, "strategy_id": strategy_id, "url": "https://arcadia.finance/farm/8453/v2?strategyId=405"},
              "raw_fields": {"strategy_apy": strategy_apy_raw, "strategy_name": strategy_name},
              "context": {"tvl": tvl, "underlyings": underlyings},
              "user_observed": {"displayed_apy_percent": displayed_apy_percent},
              "realized_inputs": {"principal_usdc": principal_str or None, "profit_usdc": profit_str or None, "duration_hours": hours_str or None}
          }

          receipt = {
              "spec_version": "v0.3.0",
              "timestamp_utc": time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime()),
              "target": {"chain_id": 8453, "strategy_id": strategy_id, "strategy_name": strategy_name, "url": "https://arcadia.finance/farm/8453/v2?strategyId=405"},
              "status": None,
              "inputs": {
                  "strategy_apy_raw_fraction": strategy_apy_raw,
                  "displayed_apy_percent_user": displayed_apy_percent,
                  "tvl_usd": tvl,
                  "underlyings": underlyings,
                  "realized_return": {
                      "principal_usdc": realized["principal_usdc"],
                      "profit_usdc": realized["profit_usdc"],
                      "duration_hours": realized["duration_hours"]
                  }
              },
              "assumptions": {
                  "apy_unit": "fraction",
                  "displayed_unit": "percent",
                  "conversion": "apy_percent = strategy_apy * 100",
                  "realized_annualization": "apr_simple = roi * (365*24/duration_hours); apy_compound_daily = (1+roi)^(365*24/duration_hours)-1"
              },
              "computed": {
                  "apy_fraction": apy_fraction,
                  "apy_percent_from_api": apy_percent_from_api,
                  "deviation_abs_percent": deviation_abs_percent,
                  "deviation_rel": deviation_rel,
                  "realized": realized
              },
              "checks": checks,
              "digests": {"input_digest_sha256": None, "output_digest_sha256": None}
          }

          receipt["digests"]["input_digest_sha256"] = sha256_hex(canonical_json_bytes(inputs_for_digest))
          receipt["digests"]["output_digest_sha256"] = sha256_hex(canonical_json_bytes(receipt))

          # --- Status ---
          if any(c["name"] == "input_present" and not c["pass"] for c in checks):
              status = "fail"
          elif any(c["name"] == "unit_confirmed" and not c["pass"] for c in checks):
              status = "fail"
          elif any(c["name"] == "realized_inputs_valid" and not c["pass"] for c in checks):
              status = "fail"
          elif (deviation_check_pass is False):
              status = "warn"
          else:
              status = "pass"

          receipt["status"] = status

          Path("artifacts/receipt.json").write_text(json.dumps(receipt, indent=2, sort_keys=True, ensure_ascii=False), encoding="utf-8")
          print("Wrote artifacts/receipt.json with status =", status)
          PY

          cp "${OUT_FILE}" "${SNAP_FILE}"
          echo "Also wrote snapshot: ${SNAP_FILE}"

      - name: Commit receipts (if changed)
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add artifacts/
          git commit -m "receipt: verify strategy 405 (add realized return)"
          git push
