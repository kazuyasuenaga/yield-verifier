name: verify

on:
  workflow_dispatch:
    inputs:
      displayed_apy_percent:
        description: "APY shown on Arcadia website (percent, e.g. 293814.8). Leave blank if unknown."
        required: false
        default: ""

permissions:
  contents: write

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build receipt from latest_strategy_405.json
        shell: bash
        env:
          DISPLAYED_APY_PERCENT: ${{ github.event.inputs.displayed_apy_percent }}
        run: |
          set -euo pipefail

          IN_FILE="data/latest_strategy_405.json"
          OUT_DIR="artifacts"
          TS="$(date -u +'%Y%m%dT%H%M%SZ')"
          OUT_FILE="${OUT_DIR}/receipt.json"
          SNAP_FILE="${OUT_DIR}/receipt_${TS}.json"

          if [ ! -f "${IN_FILE}" ]; then
            echo "ERROR: ${IN_FILE} not found. Run fetch_arcadia first."
            exit 1
          fi

          mkdir -p "${OUT_DIR}"

          python - << 'PY'
          import json, hashlib, time, sys, os
          from pathlib import Path

          displayed_str = (os.environ.get("DISPLAYED_APY_PERCENT") or "").strip()

          in_path = Path("data/latest_strategy_405.json")
          raw = json.loads(in_path.read_text(encoding="utf-8"))

          def sha256_hex(b: bytes) -> str:
              return hashlib.sha256(b).hexdigest()

          def canonical_json_bytes(obj) -> bytes:
              return json.dumps(obj, sort_keys=True, separators=(",", ":"), ensure_ascii=False).encode("utf-8")

          # --- Required fields ---
          required_keys = ["strategy_id", "strategy_name", "strategy_apy"]
          missing = [k for k in required_keys if k not in raw]

          strategy_id = raw.get("strategy_id")
          strategy_name = raw.get("strategy_name")
          strategy_apy_raw = raw.get("strategy_apy")

          underlyings = raw.get("underlyings", [])
          details = raw.get("details", {})
          tvl = details.get("total_value_locked") if isinstance(details, dict) else None

          # --- Unit decision (confirmed by user observation) ---
          apy_fraction = None
          apy_percent_from_api = None
          unit_ok = False
          unit_detail = "unknown"

          try:
              apy_fraction = float(strategy_apy_raw)
              apy_percent_from_api = apy_fraction * 100.0
              unit_ok = True
              unit_detail = "confirmed: api_fraction * 100 = displayed_percent"
          except Exception:
              unit_ok = False
              unit_detail = "strategy_apy not numeric"

          # Optional: compare against website-displayed APY% if provided
          displayed_apy_percent = None
          deviation_abs_percent = None
          deviation_rel = None
          deviation_check_pass = None
          deviation_detail = "not_provided"

          if displayed_str:
              try:
                  displayed_apy_percent = float(displayed_str)
                  if apy_percent_from_api is not None:
                      deviation_abs_percent = apy_percent_from_api - displayed_apy_percent
                      deviation_rel = deviation_abs_percent / displayed_apy_percent if displayed_apy_percent != 0 else None
                      # Tolerance: very loose for now (we mainly want to detect gross mismatch)
                      tol = 0.005  # 0.5% relative tolerance
                      deviation_check_pass = (deviation_rel is not None and abs(deviation_rel) <= tol)
                      deviation_detail = f"rel_tol={tol}"
                  else:
                      deviation_check_pass = False
                      deviation_detail = "api_percent_unavailable"
              except Exception:
                  displayed_apy_percent = None
                  deviation_check_pass = False
                  deviation_detail = "invalid_displayed_input"

          # --- Checks ---
          checks = []
          checks.append({
              "name": "input_present",
              "pass": len(missing) == 0,
              "detail": ("missing: " + ", ".join(missing)) if missing else "ok"
          })
          checks.append({
              "name": "unit_confirmed",
              "pass": unit_ok,
              "detail": unit_detail
          })
          checks.append({
              "name": "displayed_match_within_tolerance",
              "pass": (deviation_check_pass if deviation_check_pass is not None else True),
              "detail": deviation_detail
          })

          # Digests input: extracted + displayed (if provided) + identifiers
          inputs_for_digest = {
              "target": {
                  "chain_id": 8453,
                  "strategy_id": strategy_id,
                  "url": "https://arcadia.finance/farm/8453/v2?strategyId=405"
              },
              "raw_fields": {
                  "strategy_apy": strategy_apy_raw,
                  "strategy_name": strategy_name
              },
              "context": {
                  "tvl": tvl,
                  "underlyings": underlyings
              },
              "user_observed": {
                  "displayed_apy_percent": displayed_apy_percent
              }
          }

          receipt = {
              "spec_version": "v0.2.1",
              "timestamp_utc": time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime()),
              "target": {
                  "chain_id": 8453,
                  "strategy_id": strategy_id,
                  "strategy_name": strategy_name,
                  "url": "https://arcadia.finance/farm/8453/v2?strategyId=405"
              },
              "status": None,
              "inputs": {
                  "strategy_apy_raw_fraction": strategy_apy_raw,
                  "displayed_apy_percent_user": displayed_apy_percent,
                  "tvl_usd": tvl,
                  "underlyings": underlyings
              },
              "assumptions": {
                  "apy_unit": "fraction",
                  "displayed_unit": "percent",
                  "conversion": "apy_percent = strategy_apy * 100",
                  "note": "Unit confirmed using Arcadia UI observation."
              },
              "computed": {
                  "apy_fraction": apy_fraction,
                  "apy_percent_from_api": apy_percent_from_api,
                  "deviation_abs_percent": deviation_abs_percent,
                  "deviation_rel": deviation_rel
              },
              "checks": checks,
              "digests": {
                  "input_digest_sha256": None,
                  "output_digest_sha256": None
              }
          }

          input_digest = sha256_hex(canonical_json_bytes(inputs_for_digest))
          receipt["digests"]["input_digest_sha256"] = input_digest

          # Status logic
          if any(c["name"] == "input_present" and not c["pass"] for c in checks):
              status = "fail"
          elif any(c["name"] == "unit_confirmed" and not c["pass"] for c in checks):
              status = "fail"
          elif (deviation_check_pass is False):
              status = "warn"
          else:
              status = "pass"

          receipt["status"] = status

          output_digest = sha256_hex(canonical_json_bytes(receipt))
          receipt["digests"]["output_digest_sha256"] = output_digest

          Path("artifacts/receipt.json").write_text(
              json.dumps(receipt, indent=2, sort_keys=True, ensure_ascii=False),
              encoding="utf-8"
          )
          print("Wrote artifacts/receipt.json with status =", status)
          PY

          cp "${OUT_FILE}" "${SNAP_FILE}"
          echo "Also wrote snapshot: ${SNAP_FILE}"

      - name: Commit receipts (if changed)
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add artifacts/
          git commit -m "receipt: verify strategy 405 (unit confirmed)"
          git push
